---
- name: Configuration for firmware Upgrade
  hosts: all
  gather_facts: no
  connection: local
  
  tasks:
    - name: Enabling FTP server on the device...
      comware_ftp:
        username: "{{ username }}"
        password: "{{ password }}"
        hostname: "{{ inventory_hostname }}"
        state: "enable"
      ignore_errors: yes

    - name: Downloading the firmware content from FTP to the device...
      comware_file_copy:
        username: "{{ username }}"
        password: "{{ password }}"
        hostname: "{{ inventory_hostname }}"
        file: "/ansible/shared/firmware.ipe"
        remote_path: "flash:/firmware.ipe"
      ignore_errors: yes

    - name: Upgrading the device firmware...
      comware_startup:
        username: "{{ username }}"
        password: "{{ password }}"
        hostname: "{{ inventory_hostname }}"
        ipe_package: "flash:/firmware.ipe"
      ignore_errors: yes

    - name: Verifying the firmware Uploaded file before restart...
      comware_startup:
        username: "{{ username }}"
        password: "{{ password }}"
        hostname: "{{ inventory_hostname }}"
        filename: "flash:/firmware.ipe"
        show_file: "/ansible/shared/firmware_copy.ipe"
      ignore_errors: yes

    - name: Rebooting the device...
      comware_reboot:
        reboot: true
        username: "{{ username }}"
        password: "{{ password }}"
        hostname: "{{ inventory_hostname }}"
      ignore_errors: yes
